#include <WiFi.h>
#include <WebServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// ----------------------------
// WIFI SETTINGS
// ----------------------------
const char* ssid = "Balaji12";
const char* password = "Chayam@12";

// ----------------------------
// GEMINI API KEY
// ----------------------------
String apiKey = "AIzaSyDHlNLTKY950R0DzQhnu0BUhLDEsKwutKM";

// ----------------------------
WebServer server(80);

// ----------------------------
// JSON ESCAPE
// ----------------------------
String escapeJson(String s) {
  s.replace("\\", "\\\\");
  s.replace("\"", "\\\"");
  s.replace("\n", "\\n");
  s.replace("\r", "\\r");
  return s;
}

// ----------------------------
// GEMINI TEXT-ONLY FUNCTION
// ----------------------------
String askGemini(String userInput) {
  HTTPClient http;

  String url =
    "https://generativelanguage.googleapis.com/v1beta/models/"
    "gemini-2.5-flash:generateContent?key=" + apiKey;

  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  String prompt =
    "Answer ONLY in plain text. "
    "Do NOT mention images, pictures, diagrams, or links. "
    "Question: " + userInput;

  String safePrompt = escapeJson(prompt);

  String body =
    "{"
      "\"contents\": [{"
        "\"parts\": [{"
          "\"text\": \"" + safePrompt + "\""
        "}]"
      "}]"
    "}";

  int httpCode = http.POST(body);
  if (httpCode <= 0) {
    http.end();
    return "HTTP error";
  }

  String response = http.getString();
  http.end();

  DynamicJsonDocument doc(30000);
  if (deserializeJson(doc, response)) {
    return "JSON parse error";
  }

  if (doc.containsKey("error")) {
    return doc["error"]["message"].as<String>();
  }

  JsonArray parts = doc["candidates"][0]["content"]["parts"];
  String reply = "";

  for (JsonVariant p : parts) {
    if (p.containsKey("text")) {
      reply += p["text"].as<String>();
    }
  }

  reply.trim();
  return reply;
}

// ----------------------------
// BASIC WEB PAGE
// ----------------------------
const char PAGE[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<body>
<h2>ESP32 Gemini Text Chat</h2>

<textarea id="q" rows="4" cols="40"></textarea><br><br>
<button onclick="send()">Send</button>

<pre id="ans">...</pre>

<script>
function send() {
  fetch("/ask", {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: document.getElementById("q").value
  })
  .then(r => r.text())
  .then(t => document.getElementById("ans").innerText = t);
}
</script>

</body>
</html>
)rawliteral";

// ----------------------------
// WEB HANDLERS
// ----------------------------
void handleRoot() {
  server.send_P(200, "text/html", PAGE);
}

void handleAsk() {
  String q = server.arg("plain");
  q.trim();

  String reply = askGemini(q);
  server.send(200, "text/plain", reply);
}

// ----------------------------
// SETUP
// ----------------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  Serial.println("Connecting WiFi...");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nWiFi connected!");
  Serial.print("Open browser at: ");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.on("/ask", HTTP_POST, handleAsk);
  server.begin();

  Serial.println("Web chat ready!");
}

// ----------------------------
// LOOP
// ----------------------------
void loop() {
  server.handleClient();

  // Serial chat also works
  if (Serial.available()) {
    String q = Serial.readStringUntil('\n');
    q.trim();

    if (q.length() > 0) {
      Serial.println("You: " + q);
      Serial.println("Gemini: " + askGemini(q));
      Serial.println("----------------");
    }
  }
}
